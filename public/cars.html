<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cars - Speedy Sales</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
</head>
<body>
  <header class="navbar">
    <h1>Speedy Cars</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="cars.html">Cars</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="login.html">Login</a>
      <a href="signup.html">Signup</a>
    </nav>
  </header>
  
  <section class="page-container">
	  <form id="searchForm" class="form-container">
    <h2>Find Your Car</h2>

    <!-- Car Type Section -->
    <div class="section">
      <label>Select Car Type:</label>
      <div class="checkbox-group">
        <label><input type="checkbox" id="SUV" name="car_type" value="SUV">SUV</label>
        <label><input type="checkbox" id="Hatchback" name="car_type" value="Hatchback">Hatchback</label>
        <label><input type="checkbox" id="Saloon" name="car_type" value="Saloon">Saloon</label>
        <label><input type="checkbox" id="Coupe" name="car_type" value="Coupe">Coupe</label>
        <label><input type="checkbox" id="Supercar" name="car_type" value="Supercar">Supercar</label>
        <label><input type="checkbox" id="AnyCarType" name="car_type" value="Any">Any</label>
      </div>
    </div>

    <!-- Attribute Section -->
    <div class="section">
      <label>Select Attributes:</label>
      <div class="checkbox-group">
        <label><input type="checkbox" id="Fast" name="car_attribute" value="Fast">Fast</label>
        <label><input type="checkbox" id="Luxurious" name="car_attribute" value="Luxurious">Luxurious</label>
        <label><input type="checkbox" id="TwoDoor" name="car_attribute" value="two-door">2-Door</label>
        <label><input type="checkbox" id="FourDoor" name="car_attribute" value="four-door">4-Door</label>
        <label><input type="checkbox" id="TwoSeater" name="car_attribute" value="two-seater">2-Seater</label>
        <label><input type="checkbox" id="FiveSeater" name="car_attribute" value="five-seater">5-Seater</label>
        <label><input type="checkbox" id="SevenSeater" name="car_attribute" value="seven-seater">7-Seater</label>
        <label><input type="checkbox" id="AnyAttribute" name="car_attribute" value="Any">Any</label>
      </div>
    </div>

    <!-- Price Section -->
    <div class="section">
      <label>Maximum Price:</label>
      <div class="range-container">
        <input type="range" id="price" name="price" min="30000" max="3000000" value="30000" oninput="updateValue(this.value)">
        <div id="rangeValue">Â£30,000</div>
      </div>
    </div>

    <!-- Submit Button -->
    <button type="submit" class="submit-btn" onsubmit="findCars()">Search Cars</button>
  </form>
  </section>

  <section class="cars-page">
    <h2>Our Cars</h2>
    <div id="carsContainer" class="car-grid">
      <!-- Car cards will be injected here by JavaScript -->
    </div>
  </section>

  <footer>
    <p>&copy; 2025 Speedy Sales. All rights reserved.</p>
  </footer>
  
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
   const rangeInput = document.getElementById('price');
    const rangeValue = document.getElementById('rangeValue');

    function updateValue(val) {
      // Format the number as currency
      rangeValue.textContent = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(val);
    }

    // Initialize display on load
    updateValue(rangeInput.value);

    // Listen for change events
    rangeInput.addEventListener('change', () => updateValue(rangeInput.value));
  
    AOS.init();
	
	async function initialCars() {
		const response = await fetch(`/api/cars`);
        const cars = await response.json();
		loadCars(cars);
	}
	
	async function findCars() {
	    // Get the form element
		const form = document.getElementById('searchForm');

		// Add event listener for form submission
		form.addEventListener('submit', (event) => {
			event.preventDefault(); // Prevent the page from reloading

		// Grab the input values
		const selectedCarTypes = Array.from(
		  document.querySelectorAll('input[name="car_type"]:checked')
		).map(cb => cb.value);
		
		const selectedAttributes = Array.from(
		  document.querySelectorAll('input[name="car_attribute"]:checked')
		).map(cb => cb.value);
		
		const selectedPrice = document.getElementById('price').value;
		
		let types = '';
		
		selectedCarTypes.forEach((type) => {
		  types += "cartype = '" + type + "' OR ";
		});
		
		types = types.slice(0, -4); // Removes last 4 characters
		
		const query = "SELECT * FROM cars WHERE attributes @> ARRAY['" + selectedCarAttributes +"'] AND " + types + " AND price = " + selectedPrice;
		const params = new URLSearchParams(query);
		const response = await fetch(`/api/cars/query?${params.toString()}`);
        const cars = await response.json();
		
		loadCars(cars);
	}

    async function loadCars(cars) {
      try {
        const container = document.getElementById('carsContainer');
        
        if (cars.length === 0) {
          container.innerHTML = '<p>No cars available.</p>';
          return;
        }
        
        cars.forEach(car => {
          const card = document.createElement('div');
          card.className = 'car-card';
          card.setAttribute('data-aos', 'fade-up');
          
          card.innerHTML = `
            <img src="${ car.image_url ? 'images/' + car.image_url : 'images/default-car.jpg' }" alt="${car.name}" />
            <div class="car-info">
              <h4>${car.name}</h4>
              <p>${car.description}</p>
              <button onclick="window.location.href='carDetails.html?id=${car.id}'">View Details</button>
            </div>
          `;
          container.appendChild(card);
        });
      } catch (error) {
        console.error('Error loading cars:', error);
      }
    }
    
    window.addEventListener('DOMContentLoaded', initialCars);
  </script>
</body>
</html>
